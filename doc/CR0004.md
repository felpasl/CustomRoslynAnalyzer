# CR0004: Avoid Service/Repository usage inside iterations

## Description

This rule warns when classes whose names contain `Service` or `Repository` are referenced inside a `foreach` loop or within lambda expressions executed for each item (e.g., `List<T>.ForEach`). These dependencies often represent expensive I/O or stateful operations; invoking them repeatedly inside iterative constructs can severely impact performance and make behavior harder to reason about.

## Category

Usage

## Severity

Warning

## Enabled by Default

Yes

## Code Examples

### Incorrect

```csharp
public sealed class OrderProcessor
{
    private readonly OrderService _service = new();

    public void Process(IEnumerable<int> orderIds)
    {
        foreach (var id in orderIds)
        {
            _service.Save(id); // CR0004 violation
        }
    }
}
```

### Correct

```csharp
public sealed class OrderProcessor
{
    private readonly OrderService _service = new();

    public void Process(IEnumerable<int> orderIds)
    {
        var batched = new List<int>();
        foreach (var id in orderIds)
        {
            batched.Add(id);
        }

        _service.SaveRange(batched); // single call outside the loop
    }
}
```

## Why This Rule Matters

- Service and repository calls usually involve I/O or external systems and can bottleneck a tight loop.
- Invoking dependencies per iteration hides batching opportunities and introduces repeated network/DB traffic.
- Keeping the loops free of such calls encourages better separation between traversal logic and expensive operations, improving testability and performance tuning.

## Suppression

If a particular loop must invoke a service/repository and you understand the implications, you can suppress the diagnostic locally:

```csharp
#pragma warning disable CR0004
foreach (var item in items)
{
    _service.Save(item);
}
#pragma warning restore CR0004
```

Alternatively, configure rule severity in your `.editorconfig` if you want to relax the rule for specific projects or files.
