# CR0003: Avoid infrastructure calls inside loops

## Description

This rule warns when infrastructure-layer services (such as database access, HTTP calls, or file I/O) are invoked from within loop bodies. Infrastructure operations are typically costly and should be performed outside of loops to avoid performance issues.

## Category

Usage

## Severity

Warning

## Enabled by Default

Yes

## Code Examples

### Incorrect

```csharp
public class OrderProcessor
{
    private readonly IOrderRepository _repository;

    public void ProcessOrders(IEnumerable<Order> orders)
    {
        foreach (var order in orders)
        {
            // CR0003 violation: Infrastructure call inside loop
            var customer = _repository.GetCustomer(order.CustomerId);
            ProcessOrder(order, customer);
        }
    }
}
```

### Correct

```csharp
public class OrderProcessor
{
    private readonly IOrderRepository _repository;

    public void ProcessOrders(IEnumerable<Order> orders)
    {
        // Fetch all required data outside the loop
        var customerIds = orders.Select(o => o.CustomerId).Distinct();
        var customers = _repository.GetCustomers(customerIds)
            .ToDictionary(c => c.Id);

        foreach (var order in orders)
        {
            var customer = customers[order.CustomerId];
            ProcessOrder(order, customer);
        }
    }
}
```

## What Constitutes Infrastructure

Infrastructure includes, but is not limited to:

- Database queries and updates
- HTTP API calls
- File system operations
- External service calls
- Logging operations (in some contexts)

The analyzer identifies infrastructure by checking if the called method belongs to a namespace containing "Infrastructure" (case-insensitive).

## Why This Rule Matters

- Infrastructure operations are often expensive (network I/O, disk I/O, database queries).
- Performing them inside loops can lead to N+1 query problems or excessive resource usage.
- It can cause performance degradation, especially with large datasets.
- Makes code more efficient by batching operations or caching results.

## Exceptions

- Logging within loops is generally acceptable, as it's usually fast and not considered infrastructure.
- Simple in-memory operations are not flagged.

## Suppression

If you must call infrastructure within a loop for valid reasons:

```csharp
#pragma warning disable CR0003
foreach (var item in items)
{
    _infrastructureService.Process(item); // Allowed with suppression
}
#pragma warning restore CR0003
```

Consider refactoring to move the call outside the loop when possible.</content>
<parameter name="filePath">/workspaces/RoselynCustomAnalyzer/doc/CR0003.md