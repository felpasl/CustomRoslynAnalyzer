name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., v1.2.3 or 1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  pack:
    runs-on: windows-latest
    outputs:
      package_path: ${{ steps.pack.outputs.package_path }}
      package_name: ${{ steps.pack.outputs.package_name }}
      package_version: ${{ steps.determine-version.outputs.version }}
      release_tag: ${{ steps.determine-version.outputs.raw_version }}
      release_upload_url: ${{ steps.release-url.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore CustomRoslynAnalyzer/CustomRoslynAnalyzer.csproj

      - name: Determine package version
        id: determine-version
        shell: bash
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            RAW_VERSION="${{ github.event.inputs.version }}"
          else
            RAW_VERSION="${{ github.event.release.tag_name }}"
          fi

          if [ -z "$RAW_VERSION" ]; then
            echo "Package version was not provided." >&2
            exit 1
          fi

          VERSION="${RAW_VERSION#v}"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "raw_version=$RAW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Pack analyzer
        id: pack
        shell: bash
        run: |
          VERSION="${{ steps.determine-version.outputs.version }}"
          sed -i 's|<version>.*</version>|<version>$VERSION</version>|' CustomRoslynAnalyzer/CustomRoslynAnalyzer.nuspec
          sed -i 's|<Version>.*</Version>|<Version>$VERSION</Version>|' CustomRoslynAnalyzer/CustomRoslynAnalyzer.csproj
          dotnet pack CustomRoslynAnalyzer/CustomRoslynAnalyzer.csproj \
            --configuration Release \
            -p:PackageVersion="$VERSION" \
            --output artifacts/nuget
          PACKAGE_PATH=$(ls artifacts/nuget/*.nupkg | head -n 1)
          if [ -z "$PACKAGE_PATH" ]; then
            echo "Package was not created" >&2
            exit 1
          fi
          PACKAGE_NAME=$(basename "$PACKAGE_PATH")
          echo "package_path=$PACKAGE_PATH" >> "$GITHUB_OUTPUT"
          echo "package_name=$PACKAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: Publish package to NuGet
        shell: bash
        run: |
          file="${{ steps.pack.outputs.package_path }}"
          dotnet nuget push "$file" \
            --api-key "${{ secrets.NUGET_KEY }}" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

      - name: Upload package artifact
        uses: actions/upload-artifact@v5
        with:
          name: nuget-package
          path: ${{ steps.pack.outputs.package_path }}

      - name: Resolve release upload URL
        id: release-url
        shell: bash
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            echo "upload_url=${{ github.event.release.upload_url }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload package to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.determine-version.outputs.raw_version }}" '${{ steps.pack.outputs.package_path }}' || true

  sonar-plugin:
    runs-on: windows-latest
    needs: pack
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download packaged analyzer
        uses: actions/download-artifact@v6
        with:
          name: nuget-package
          path: artifacts/nuget

      - name: Download SonarQube Roslyn SDK
        shell: bash
        run: |
          SDK_ZIP="$RUNNER_TEMP/SonarQube.Roslyn.SDK.zip"
          curl -L -o "$SDK_ZIP" https://github.com/SonarSource/sonarqube-roslyn-sdk/releases/download/4.0/SonarQube.Roslyn.SDK-4.0.zip
          SDK_DIR="$RUNNER_TEMP/SonarQube.Roslyn.SDK"
          rm -rf "$SDK_DIR"
          mkdir -p "$SDK_DIR"
          unzip -q "$SDK_ZIP" -d "$SDK_DIR"
          echo "SDK_DIR=$SDK_DIR" >> "$GITHUB_ENV"

      - name: Prepare local NuGet feed
        shell: bash
        run: |
          LOCAL_FEED="/c/LocalNuGetFeed"
          mkdir -p "$LOCAL_FEED"
          cp artifacts/nuget/*.nupkg "$LOCAL_FEED/"

      - name: Generate SonarQube plugin
        id: generate-plugin
        shell: pwsh
        run: |
          $version = '${{ needs.pack.outputs.package_version }}'
          $sdkPath = Join-Path $env:SDK_DIR 'RoslynSonarQubePluginGenerator.exe'
          & $sdkPath /analyzer:"CustomRoslynAnalyzer:$version" /customnugetrepo:"C:\LocalNuGetFeed" /recurse
          $pluginJar = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter 'CustomRoslynAnalyzer-plugin*.jar' -Recurse -File | Select-Object -First 1
          if (-not $pluginJar) {
            Write-Error 'SonarQube plugin jar not found'
            exit 1
          }
          $releaseTag = '${{ needs.pack.outputs.release_tag }}'
          if (-not $releaseTag) {
            $releaseTag = '${{ needs.pack.outputs.package_version }}'
          }
          $pluginDir = Join-Path $env:GITHUB_WORKSPACE 'artifacts/sonarqube'
          New-Item -ItemType Directory -Path $pluginDir -Force | Out-Null
          $pluginReleaseName = "CustomRoslynAnalyzer-plugin.$releaseTag.jar"
          $pluginDest = Join-Path $pluginDir $pluginReleaseName
          Copy-Item -Path $pluginJar.FullName -Destination $pluginDest -Force
          echo "plugin_path=$pluginDest" >> $env:GITHUB_OUTPUT
          echo "plugin_name=$pluginReleaseName" >> $env:GITHUB_OUTPUT

      - name: Upload SonarQube plugin artifact
        uses: actions/upload-artifact@v5
        with:
          name: sonarqube-plugin
          path: ${{ steps.generate-plugin.outputs.plugin_path }}

      - name: Upload plugin to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.pack.outputs.release_tag }}" '${{ steps.generate-plugin.outputs.plugin_path }}' || true
